---
import Icon from "./Icon.astro";
---

<button
  id="theme-toggle"
  type="button"
  aria-label="Toggle dark mode"
  class="relative p-2 rounded-lg text-text-tertiary hover:text-text-primary hover:bg-bg-tertiary transition-colors duration-200 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
>
  <span id="theme-icon-sun" class="hidden">
    <Icon name="sun" size={20} />
  </span>
  <span id="theme-icon-moon" class="hidden">
    <Icon name="moon" size={20} />
  </span>
</button>

<script is:inline>
  (function () {
    if (window.__themeToggleInit) {
      // Second instance â€” just sync its icons
      var allSuns = document.querySelectorAll('[id="theme-icon-sun"]');
      var allMoons = document.querySelectorAll('[id="theme-icon-moon"]');
      var isDark = document.documentElement.classList.contains("dark");
      allSuns.forEach(function (s) { s.classList.toggle("hidden", !isDark); });
      allMoons.forEach(function (m) { m.classList.toggle("hidden", isDark); });
      return;
    }
    window.__themeToggleInit = true;

    function updateAllIcons() {
      var isDark = document.documentElement.classList.contains("dark");
      document.querySelectorAll('[id="theme-icon-sun"]').forEach(function (s) {
        s.classList.toggle("hidden", !isDark);
      });
      document.querySelectorAll('[id="theme-icon-moon"]').forEach(function (m) {
        m.classList.toggle("hidden", isDark);
      });
      document.querySelectorAll('[id="theme-toggle"]').forEach(function (btn) {
        btn.setAttribute("aria-label", isDark ? "Switch to light mode" : "Switch to dark mode");
      });
    }

    updateAllIcons();

    document.querySelectorAll('[id="theme-toggle"]').forEach(function (btn) {
      btn.addEventListener("click", function () {
        document.documentElement.classList.toggle("dark");
        var isDark = document.documentElement.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateAllIcons();
      });
    });
  })();
</script>
